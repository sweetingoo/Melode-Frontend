<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Management - Melode Healthcare Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Configuration -->
    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen" x-data="roleManagementApp()">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-2xl font-bold text-primary-600">Melode</h1>
                    </div>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                    <a href="superadmin-dashboard.html" class="text-gray-500 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-home mr-1"></i>Dashboard
                        </a>
                        <a href="user-management.html" class="text-gray-500 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-users mr-1"></i>Users
                        </a>
                        <a href="role-management.html" class="text-primary-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-shield-alt mr-1"></i>Roles
                        </a>
                        <a href="permissions-management.html" class="text-gray-500 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-key mr-1"></i>Permissions
                        </a>
                        <a href="invitations.html" class="text-gray-500 hover:text-primary-600 px-3 py-2 rounded-md text-sm font-medium">
                            <i class="fas fa-envelope mr-1"></i>Invitations
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <!-- Page Header -->
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Role Management</h2>
                    <p class="text-sm text-gray-500 mt-1">Manage roles and their permissions</p>
                </div>
                <button 
                    @click="showCreateRole = true"
                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
                    <i class="fas fa-plus mr-2"></i>
                    Create Role
                            </button>
                        </div>
                        
            <!-- Loading State -->
            <div x-show="isLoading" class="text-center py-12">
                <i class="fas fa-spinner fa-spin text-4xl text-primary-600 mb-4"></i>
                <p class="text-gray-600">Loading roles...</p>
            </div>

            <!-- Roles Grid -->
            <div x-show="!isLoading" class="grid grid-cols-1 gap-6 lg:grid-cols-2">
                            <template x-for="role in roles" :key="role.id">
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <!-- Role Header -->
                        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                                    <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <i class="fas fa-shield-alt text-primary-600 text-xl mr-3"></i>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900" x-text="role.display_name"></h3>
                                        <p class="text-sm text-gray-500" x-text="role.name"></p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span 
                                        x-show="role.is_system"
                                        class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                        System
                                    </span>
                                    <button 
                                        @click="editRole(role)"
                                        class="text-primary-600 hover:text-primary-800 p-2"
                                        title="Edit role">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button 
                                        x-show="!role.is_system"
                                        @click="deleteRole(role.id)"
                                        class="text-red-600 hover:text-red-800 p-2"
                                        title="Delete role">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Role Details -->
                        <div class="px-6 py-4">
                            <p class="text-sm text-gray-600 mb-4" x-text="role.description"></p>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                                <div>
                                    <span class="text-gray-500">Priority:</span>
                                    <span class="font-medium text-gray-900 ml-2" x-text="role.priority"></span>
                    </div>
                                <div>
                                    <span class="text-gray-500">Users:</span>
                                    <span class="font-medium text-gray-900 ml-2" x-text="role.user_count || 0"></span>
                </div>
            </div>

                            <!-- Permissions -->
                            <div class="border-t pt-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h4 class="text-sm font-medium text-gray-900">
                                        Permissions (<span x-text="role.permissions ? role.permissions.length : 0"></span>)
                                    </h4>
                                    <button 
                                        @click="managePermissions(role)"
                                        class="text-sm text-primary-600 hover:text-primary-800">
                                        <i class="fas fa-cog mr-1"></i>
                                        Manage
                            </button>
                        </div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="permission in (role.permissions || []).slice(0, 5)" :key="permission.id">
                                        <span class="px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-700" x-text="permission.display_name"></span>
                                    </template>
                                    <span 
                                        x-show="role.permissions && role.permissions.length > 5"
                                        class="px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-600"
                                        x-text="'+' + (role.permissions.length - 5) + ' more'">
                                    </span>
                                    <span 
                                        x-show="!role.permissions || role.permissions.length === 0"
                                        class="text-xs text-gray-400">
                                        No permissions assigned
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </main>

    <!-- Create/Edit Role Modal -->
    <div x-show="showCreateRole || showEditRole" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900" x-text="showEditRole ? 'Edit Role' : 'Create New Role'"></h3>
                    <button @click="closeRoleModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form @submit.prevent="saveRole()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Display Name *</label>
                        <input 
                            type="text" 
                            x-model="roleForm.display_name"
                            required
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            placeholder="e.g., Senior Doctor">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Role Name *</label>
                        <input 
                            type="text" 
                            x-model="roleForm.name"
                            :disabled="showEditRole"
                            required
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm disabled:bg-gray-100"
                            placeholder="e.g., senior_doctor">
                        <p class="mt-1 text-xs text-gray-500">Lowercase with underscores only. Cannot be changed after creation.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea 
                            x-model="roleForm.description"
                            rows="3"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            placeholder="Describe this role's purpose and responsibilities"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Priority</label>
                        <input 
                            type="number" 
                            x-model.number="roleForm.priority"
                            min="0"
                            max="100"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm"
                            placeholder="0-100 (higher = more important)">
                    </div>

                    <div class="flex justify-end space-x-3 pt-4">
                        <button 
                            type="button" 
                            @click="closeRoleModal()"
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                            Cancel
                        </button>
                        <button 
                            type="submit" 
                            :disabled="isSaving"
                            class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50">
                            <span x-show="!isSaving" x-text="showEditRole ? 'Update Role' : 'Create Role'"></span>
                            <span x-show="isSaving">Saving...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Manage Permissions Modal -->
    <div x-show="showPermissionsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Manage Permissions</h3>
                        <p class="text-sm text-gray-500" x-text="selectedRole ? selectedRole.display_name : ''"></p>
                    </div>
                    <button @click="showPermissionsModal = false" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                    </div>

                <!-- Search Permissions -->
                    <div class="mb-4">
                    <input 
                        type="text" 
                        x-model="permissionSearch"
                        placeholder="Search permissions..."
                        class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                    </div>

                <!-- Permissions List -->
                <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                    <input 
                                        type="checkbox"
                                        @change="toggleAllPermissions($event.target.checked)"
                                        class="rounded border-gray-300">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Permission</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Resource</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="permission in filteredPermissions" :key="permission.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3">
                                        <input 
                                            type="checkbox"
                                            :checked="isPermissionSelected(permission.id)"
                                            @change="togglePermission(permission.id, $event.target.checked)"
                                            class="rounded border-gray-300">
                                    </td>
                                    <td class="px-4 py-3 text-sm text-gray-900" x-text="permission.display_name"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="permission.resource"></td>
                                    <td class="px-4 py-3 text-sm text-gray-500" x-text="permission.action"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    </div>

                <!-- Save Button -->
                <div class="flex justify-end space-x-3 pt-4">
                    <button 
                        @click="showPermissionsModal = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                            Cancel
                        </button>
                    <button 
                        @click="savePermissions()"
                        :disabled="isSaving"
                        class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-md hover:bg-primary-700 disabled:opacity-50">
                        <span x-show="!isSaving">Save Permissions</span>
                        <span x-show="isSaving">Saving...</span>
                        </button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        function roleManagementApp() {
            return {
                roles: [],
                allPermissions: [],
                selectedRole: null,
                selectedPermissionIds: [],
                permissionSearch: '',
                
                showCreateRole: false,
                showEditRole: false,
                showPermissionsModal: false,
                isLoading: true,
                isSaving: false,
                
                roleForm: {
                    name: '',
                    display_name: '',
                    description: '',
                    priority: 50
                },

                async init() {
                    await this.loadData();
                },

                async loadData() {
                    this.isLoading = true;
                    try {
                        const token = localStorage.getItem('access_token');
                        
                        const [rolesResponse, permissionsResponse] = await Promise.all([
                            fetch(${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/', {
                                headers: { 'Authorization': 'Bearer ' + token }
                            }),
                            fetch(${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/permissions/', {
                                headers: { 'Authorization': 'Bearer ' + token }
                            })
                        ]);

                        if (rolesResponse.ok) {
                            this.roles = await rolesResponse.json();
                        }
                        
                        if (permissionsResponse.ok) {
                            this.allPermissions = await permissionsResponse.json();
                        }
                    } catch (error) {
                        console.error('Error loading data:', error);
                        alert('Failed to load roles and permissions');
                    } finally {
                        this.isLoading = false;
                    }
                },

                editRole(role) {
                    this.selectedRole = role;
                    this.roleForm = {
                        name: role.name,
                        display_name: role.display_name,
                        description: role.description,
                        priority: role.priority
                    };
                    this.showEditRole = true;
                },

                closeRoleModal() {
                    this.showCreateRole = false;
                    this.showEditRole = false;
                    this.selectedRole = null;
                    this.roleForm = {
                        name: '',
                        display_name: '',
                        description: '',
                        priority: 50
                    };
                },

                async saveRole() {
                    this.isSaving = true;
                    try {
                        const token = localStorage.getItem('access_token');
                        const url = this.showEditRole 
                            ? ${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/' + this.selectedRole.id
                            : ${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/';
                        
                        const response = await fetch(url, {
                            method: this.showEditRole ? 'PUT' : 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.roleForm)
                        });

                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Failed to save role');
                        }

                        this.showSuccess(this.showEditRole ? 'Role updated successfully' : 'Role created successfully');
                        this.closeRoleModal();
                        await this.loadData();
                    } catch (error) {
                        console.error('Error saving role:', error);
                        alert('Failed to save role: ' + error.message);
                    } finally {
                        this.isSaving = false;
                    }
                },

                async deleteRole(roleId) {
                    if (!confirm('Are you sure you want to delete this role? This action cannot be undone.')) return;
                    
                    try {
                        const token = localStorage.getItem('access_token');
                        const response = await fetch(${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/' + roleId, {
                            method: 'DELETE',
                            headers: { 'Authorization': 'Bearer ' + token }
                        });

                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Failed to delete role');
                        }

                        this.showSuccess('Role deleted successfully');
                        await this.loadData();
                    } catch (error) {
                        console.error('Error deleting role:', error);
                        alert('Failed to delete role: ' + error.message);
                    }
                },

                managePermissions(role) {
                    this.selectedRole = role;
                    this.selectedPermissionIds = (role.permissions || []).map(p => p.id);
                    this.showPermissionsModal = true;
                },

                get filteredPermissions() {
                    if (!this.permissionSearch) return this.allPermissions;
                    
                    const search = this.permissionSearch.toLowerCase();
                    return this.allPermissions.filter(p => 
                        p.display_name.toLowerCase().includes(search) ||
                        p.name.toLowerCase().includes(search) ||
                        p.resource.toLowerCase().includes(search) ||
                        p.action.toLowerCase().includes(search)
                    );
                },

                isPermissionSelected(permissionId) {
                    return this.selectedPermissionIds.includes(permissionId);
                },

                togglePermission(permissionId, checked) {
                    if (checked) {
                        if (!this.selectedPermissionIds.includes(permissionId)) {
                            this.selectedPermissionIds.push(permissionId);
                        }
                    } else {
                        this.selectedPermissionIds = this.selectedPermissionIds.filter(id => id !== permissionId);
                    }
                },

                toggleAllPermissions(checked) {
                    if (checked) {
                        this.selectedPermissionIds = this.filteredPermissions.map(p => p.id);
                        } else {
                        this.selectedPermissionIds = [];
                    }
                },

                async savePermissions() {
                    this.isSaving = true;
                    try {
                        const token = localStorage.getItem('access_token');
                        const response = await fetch(${window.getApiBaseUrl ? window.getApiBaseUrl() : 'http://127.0.0.1:8000/api/v1'}/roles/' + this.selectedRole.id, {
                            method: 'PUT',
                            headers: {
                                'Authorization': 'Bearer ' + token,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                display_name: this.selectedRole.display_name,
                                description: this.selectedRole.description,
                                priority: this.selectedRole.priority,
                                permission_ids: this.selectedPermissionIds
                            })
                        });

                        if (!response.ok) {
                            const error = await response.json().catch(() => ({}));
                            throw new Error(error.detail || 'Failed to save permissions');
                        }

                        this.showSuccess('Permissions updated successfully');
                        this.showPermissionsModal = false;
                        await this.loadData();
                    } catch (error) {
                        console.error('Error saving permissions:', error);
                        alert('Failed to save permissions: ' + error.message);
                    } finally {
                        this.isSaving = false;
                    }
                },

                showSuccess(message) {
                    const div = document.createElement('div');
                    div.className = 'fixed top-4 right-4 bg-green-100 border border-green-400 text-green-800 px-4 py-3 rounded shadow-lg z-50';
                    div.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + message;
                    document.body.appendChild(div);
                    setTimeout(function() { div.remove(); }, 3000);
                }
            };
        }
    </script>
    <script src="js/auth-utils.js"></script>
</body>
</html>
