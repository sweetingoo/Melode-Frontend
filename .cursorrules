# Cursor Rules for Melode Frontend

## Project Context
This is a Next.js frontend application for the Melode project. The codebase uses React, Next.js, and modern JavaScript/JSX patterns.

## Code Style & Conventions
- Use functional components with hooks
- Follow existing code patterns and structure
- Use consistent naming conventions (camelCase for variables/functions, PascalCase for components)
- Prefer explicit imports over default imports when possible
- Use British English spelling: use 's' instead of 'z' (e.g., "organise" not "organize", "customise" not "customize")

## File Organization
- Components go in `/components`
- Hooks go in `/hooks`
- Services/API clients go in `/services`
- Utilities go in `/utils`
- Pages/routes go in `/app` following Next.js App Router structure

## Documentation
- **NEVER create documentation files unless explicitly asked by the user**
- Do not create README files, markdown files, or any documentation unless the user specifically requests it
- Do not proactively create documentation even if it seems helpful
- Only create documentation files when the user explicitly asks for them
- Focus on code implementation rather than documentation

## Database & Migrations
- Do not create migrations manually
- Let the backend handle database migrations
- Use --autogenerate. The DATABASE_URL is already in .env

## Testing
- Maintain existing test patterns
- Tests are located in `__tests__` directory
- Use Jest for unit tests and Playwright for E2E tests

## Code Quality
- Write clean, maintainable code
- Follow existing error handling patterns
- Use TypeScript-style JSDoc comments when helpful
- Ensure code is properly formatted and linted

## Lists & Pagination
- **Never use large fixed page sizes** (e.g. per_page: 200) to load "all" records for dropdowns or filters
- Use **lazy loading** for large lists: search-as-you-type APIs, pagination, or virtualisation
- Prefer server-side search/suggest endpoints (e.g. `/employees/suggest?q=...&limit=20`) over loading hundreds of records and filtering client-side
- Keep default page sizes modest (e.g. 20–50); use "load more" or infinite scroll if the user needs more

## API Integration
- Use the existing API client patterns in `/services`
- Follow the established authentication and token management patterns
- Handle errors gracefully using existing error handling utilities
- **ALWAYS use slugs (strings) instead of IDs (integers) for all API path parameters**
- Use `entitySlug`, `userSlug`, `taskSlug`, `projectSlug`, etc. for path parameters
- Request bodies and query parameters may still use IDs where appropriate (as per migration guide)
- When working with entities, always pass `slug` values to API endpoints, not `id` values
- **For backward compatibility with existing entries that may not have slugs:**
  - Use `entity.slug || entity.id` pattern when constructing URLs or API calls
  - This ensures existing entries without slugs still work (fallback to ID)
  - Example: `href={`/admin/trackers/entries/${entry.slug || entry.id}`}`
- **Tracker entries specifically:** Always use `entry.slug || entry.id` when linking to or referencing tracker entries

## File Handling (Cursor knowledge – upload & retrieve)

**Endpoints:**
- Upload: `POST /api/v1/settings/files/upload`
- Retrieve URL: `GET /api/v1/settings/files/{file_identifier}/download`

**Process 1 – Upload (correct when):**
1. Upload using the upload endpoint above.
2. From the response, get `file_reference_id` (or fallback to `file_id` if that’s all the backend returns).
3. Pass that value as the **form submission value for the file field** (key = field name / field_id). Do not send the raw File object in the submission.

**Process 2 – Retrieve (correct when):**
1. When you have entry/details, the value for the file field (key = **field name**) is `file_reference_id` (or `file_id`).
2. Call the file URL endpoint: `GET /api/v1/settings/files/{file_reference_id}/download` (or use `file_id` if that’s what you have).
3. The endpoint returns **JSON** (e.g. `{ "download_url": "https://...", "file_id": 70 }`). Do **not** request this endpoint with `responseType: "blob"`.
4. Use the **`download_url`** from the response (e.g. `window.open(download_url)`) to open or download the file.

**Rules:**
- **NEVER** store or use direct S3 signed URLs for persistence; they expire. Store only `file_reference_id` (or `file_id`) per field.
- **ALWAYS** use the upload endpoint above for file uploads; then put the returned reference into the form submission for that field.
- To show a “View”/“Download” link: call the retrieve endpoint with the field’s value (file_reference_id/file_id), then open the returned `download_url`.

